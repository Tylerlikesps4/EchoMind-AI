import { useState, useEffect, useRef } from 'react';
import { base44 } from '@/api/base44Client';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Input } from "@/components/ui/input";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Menu, Settings, Sparkles, BookOpen, Loader2, Target } from 'lucide-react';
import { AnimatePresence } from 'framer-motion';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import { toast } from 'sonner';

import MessageBubble from '@/components/chat/MessageBubble';
import TypingIndicator from '@/components/chat/TypingIndicator';
import ChatInput from '@/components/chat/ChatInput';
import ConversationList from '@/components/chat/ConversationList';
import WelcomeScreen from '@/components/chat/WelcomeScreen';
import EmotionalInsights from '@/components/chat/EmotionalInsights';
import SkillsPanel from '@/components/chat/SkillsPanel';
import MediaMessage from '@/components/chat/MediaMessage';
import ProactiveSuggestions from '@/components/chat/ProactiveSuggestions';
import ProjectHub from '@/components/projects/ProjectHub';
import PracticeExercise from '@/components/learning/PracticeExercise';
import ReflectionPrompt from '@/components/reflection/ReflectionPrompt';

export default function Chat() {
    const [currentConversation, setCurrentConversation] = useState(null);
    const [messages, setMessages] = useState([]);
    const [isTyping, setIsTyping] = useState(false);
    const [sidebarOpen, setSidebarOpen] = useState(false);
    const [skillsPanelOpen, setSkillsPanelOpen] = useState(false);
    const [imageGenDialogOpen, setImageGenDialogOpen] = useState(false);
    const [imagePrompt, setImagePrompt] = useState('');
    const [generatingImage, setGeneratingImage] = useState(false);
    const scrollRef = useRef(null);
    const queryClient = useQueryClient();

    // Fetch user profile for AI name
    const { data: profiles } = useQuery({
        queryKey: ['userProfile'],
        queryFn: () => base44.entities.UserProfile.list(),
    });
    
    const userProfile = profiles?.[0];
    const aiName = userProfile?.ai_name || 'ARIA';

    // Fetch active goal for Project Hub
    const { data: activeGoals = [] } = useQuery({
        queryKey: ['activeGoals'],
        queryFn: () => base44.entities.Goal.filter({ status: 'active' }, '-updated_date', 1),
    });

    // Fetch pending practice exercises
    const { data: exercises = [] } = useQuery({
        queryKey: ['practiceExercises'],
        queryFn: () => base44.entities.PracticeExercise.filter({ status: 'pending' }, '-created_date', 1),
    });

    // Fetch unread reflection prompts
    const { data: reflections = [] } = useQuery({
        queryKey: ['reflectionPrompts'],
        queryFn: () => base44.entities.MemoryInsight.filter({ is_read: false }, '-created_date', 1),
    });

    // Fetch conversations
    const { data: conversations = [], isLoading: loadingConversations } = useQuery({
        queryKey: ['conversations'],
        queryFn: () => base44.entities.Conversation.list('-created_date'),
    });

    // Create new conversation
    const createConversation = useMutation({
        mutationFn: async () => {
            const conv = await base44.agents.createConversation({
                agent_name: 'companion',
                metadata: { name: 'New conversation' }
            });
            await base44.entities.Conversation.create({
                title: 'New conversation',
                mood: 'curious'
            });
            return conv;
        },
        onSuccess: (conv) => {
            setCurrentConversation(conv);
            setMessages([]);
            queryClient.invalidateQueries({ queryKey: ['conversations'] });
            setSidebarOpen(false);
        }
    });

    // Subscribe to conversation updates
    useEffect(() => {
        if (!currentConversation?.id) return;
        
        const unsubscribe = base44.agents.subscribeToConversation(
            currentConversation.id, 
            (data) => {
                setMessages(data.messages || []);
                const lastMsg = data.messages?.[data.messages.length - 1];
                setIsTyping(lastMsg?.role === 'user' || (lastMsg?.role === 'assistant' && !lastMsg.content));
            }
        );

        return () => unsubscribe();
    }, [currentConversation?.id]);

    // Scroll to bottom on new messages
    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
    }, [messages, isTyping]);

    const handleSendMessage = async (content, fileUrls = []) => {
        if (!currentConversation) {
            const conv = await createConversation.mutateAsync();
            await base44.agents.addMessage(conv, { 
                role: 'user', 
                content,
                ...(fileUrls.length > 0 && { file_urls: fileUrls })
            });
        } else {
            await base44.agents.addMessage(currentConversation, { 
                role: 'user', 
                content,
                ...(fileUrls.length > 0 && { file_urls: fileUrls })
            });
        }
    };

    const handleExerciseSubmit = async (exerciseId, answer) => {
        // Send answer to ARIA for feedback
        await handleSendMessage(`Here's my answer to the practice exercise:\n\n${answer}\n\nCan you provide feedback?`);
        
        // Update exercise with user's answer
        await base44.entities.PracticeExercise.update(exerciseId, {
            user_answer: answer,
            status: 'attempted'
        });
        queryClient.invalidateQueries({ queryKey: ['practiceExercises'] });
    };

    const handleRequestHint = async (exerciseId) => {
        await handleSendMessage("Can I get a hint for this exercise?");
    };

    const handleReflectionRespond = async (insight) => {
        await handleSendMessage(`I'd like to reflect on: ${insight.title}`);
        // Mark as read
        await base44.entities.MemoryInsight.update(insight.id, { is_read: true });
        queryClient.invalidateQueries({ queryKey: ['reflectionPrompts'] });
    };

    const handleReflectionDismiss = async (insightId) => {
        await base44.entities.MemoryInsight.update(insightId, { is_read: true });
        queryClient.invalidateQueries({ queryKey: ['reflectionPrompts'] });
    };

    const handleGenerateImage = async () => {
        if (!imagePrompt.trim()) {
            toast.error('Please describe the image you want to generate');
            return;
        }

        setGeneratingImage(true);
        try {
            const { url } = await base44.integrations.Core.GenerateImage({ 
                prompt: imagePrompt 
            });
            
            // Send the generated image to the conversation
            await handleSendMessage(`Generated image: ${imagePrompt}`, [url]);
            setImageGenDialogOpen(false);
            setImagePrompt('');
            toast.success('Image generated!');
        } catch (error) {
            toast.error('Failed to generate image');
        } finally {
            setGeneratingImage(false);
        }
    };

    const handleSuggestSkill = async () => {
        if (!currentConversation) {
            const conv = await createConversation.mutateAsync();
            await base44.agents.addMessage(conv, { 
                role: 'user', 
                content: "I'd like to learn something new. What skills could you teach me based on my interests?"
            });
        } else {
            await base44.agents.addMessage(currentConversation, { 
                role: 'user', 
                content: "I'd like to learn something new. What skills could you teach me based on my interests?"
            });
        }
        setSkillsPanelOpen(false);
    };

    const handleSelectConversation = async (conv) => {
        const fullConv = await base44.agents.getConversation(conv.id);
        setCurrentConversation(fullConv);
        setMessages(fullConv.messages || []);
        setSidebarOpen(false);
    };

    const handleDeleteConversation = async (id) => {
        // Delete from our entity
        const convs = await base44.entities.Conversation.filter({ id });
        if (convs[0]) {
            await base44.entities.Conversation.delete(convs[0].id);
        }
        queryClient.invalidateQueries({ queryKey: ['conversations'] });
        if (currentConversation?.id === id) {
            setCurrentConversation(null);
            setMessages([]);
        }
    };

    const handleStartChat = () => {
        createConversation.mutate();
    };

    const Sidebar = () => (
        <div className="flex flex-col h-full bg-slate-900/95 backdrop-blur-xl">
            <div className="p-4 border-b border-slate-800/50">
                <div className="flex items-center gap-3">
                    <div className="h-10 w-10 rounded-2xl bg-gradient-to-br from-violet-500 via-purple-500 to-fuchsia-500 flex items-center justify-center shadow-lg shadow-purple-500/20">
                        <Sparkles className="h-5 w-5 text-white" />
                    </div>
                    <div>
                        <h1 className="font-semibold text-slate-100">{aiName}</h1>
                        <p className="text-xs text-slate-500">Your AI Companion</p>
                    </div>
                </div>
            </div>
            
            <ConversationList
                conversations={conversations}
                currentId={currentConversation?.id}
                onSelect={handleSelectConversation}
                onNew={() => createConversation.mutate()}
                onDelete={handleDeleteConversation}
                isLoading={loadingConversations}
            />

            <div className="p-4 border-t border-slate-800/50 space-y-2">
                <Button 
                    variant="ghost" 
                    className="w-full justify-start text-slate-400 hover:text-slate-200 hover:bg-slate-800/50 rounded-xl"
                    onClick={() => {
                        setSkillsPanelOpen(true);
                        setSidebarOpen(false);
                    }}
                >
                    <BookOpen className="h-4 w-4 mr-3" />
                    Learning
                </Button>
                <Link to={createPageUrl('Goals')}>
                    <Button variant="ghost" className="w-full justify-start text-slate-400 hover:text-slate-200 hover:bg-slate-800/50 rounded-xl">
                        <Menu className="h-4 w-4 mr-3" />
                        Goals
                    </Button>
                </Link>
                <Link to={createPageUrl('Settings')}>
                    <Button variant="ghost" className="w-full justify-start text-slate-400 hover:text-slate-200 hover:bg-slate-800/50 rounded-xl">
                        <Settings className="h-4 w-4 mr-3" />
                        Settings
                    </Button>
                </Link>
            </div>
        </div>
    );

    return (
        <div className="h-screen bg-slate-950 flex overflow-hidden">
            {/* Desktop Sidebar */}
            <div className="hidden md:flex w-80 border-r border-slate-800/50 flex-shrink-0">
                <Sidebar />
            </div>

            {/* Mobile Sidebar */}
            <Sheet open={sidebarOpen} onOpenChange={setSidebarOpen}>
                <SheetContent side="left" className="p-0 w-80 bg-slate-900 border-slate-800">
                    <Sidebar />
                </SheetContent>
            </Sheet>

            {/* Skills Panel */}
            <Sheet open={skillsPanelOpen} onOpenChange={setSkillsPanelOpen}>
                <SheetContent side="right" className="p-0 w-80 bg-slate-900 border-slate-800">
                    <SkillsPanel onSuggestSkill={handleSuggestSkill} />
                </SheetContent>
            </Sheet>

            {/* Image Generation Dialog */}
            <Dialog open={imageGenDialogOpen} onOpenChange={setImageGenDialogOpen}>
                <DialogContent className="bg-slate-900 border-slate-800">
                    <DialogHeader>
                        <DialogTitle className="text-slate-100">Generate Image</DialogTitle>
                        <DialogDescription className="text-slate-400">
                            Describe the image you want to create with AI
                        </DialogDescription>
                    </DialogHeader>
                    <Input
                        value={imagePrompt}
                        onChange={(e) => setImagePrompt(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && !generatingImage && handleGenerateImage()}
                        placeholder="A beautiful sunset over mountains..."
                        className="bg-slate-800/50 border-slate-700 text-slate-100"
                        disabled={generatingImage}
                    />
                    <DialogFooter>
                        <Button
                            onClick={handleGenerateImage}
                            disabled={generatingImage || !imagePrompt.trim()}
                            className="bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500"
                        >
                            {generatingImage ? (
                                <>
                                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                                    Generating...
                                </>
                            ) : (
                                'Generate Image'
                            )}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            {/* Main Chat Area */}
            <div className="flex-1 flex flex-col min-w-0">
                {/* Header */}
                <header className="h-16 border-b border-slate-800/50 flex items-center px-4 gap-4 bg-slate-900/50 backdrop-blur-xl flex-shrink-0">
                    <Sheet open={sidebarOpen} onOpenChange={setSidebarOpen}>
                        <SheetTrigger asChild>
                            <Button variant="ghost" size="icon" className="md:hidden text-slate-400 hover:text-slate-200 rounded-xl">
                                <Menu className="h-5 w-5" />
                            </Button>
                        </SheetTrigger>
                    </Sheet>
                    
                    <div className="flex items-center gap-3 flex-1">
                        <div className="h-9 w-9 rounded-xl bg-gradient-to-br from-violet-500 via-purple-500 to-fuchsia-500 flex items-center justify-center shadow-lg shadow-purple-500/20">
                            <Sparkles className="h-4 w-4 text-white" />
                        </div>
                        <div>
                            <h2 className="font-medium text-slate-100">{aiName}</h2>
                            <p className="text-xs text-emerald-400 flex items-center gap-1">
                                <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse" />
                                Online
                            </p>
                        </div>
                    </div>

                    <div className="hidden md:flex gap-1">
                        <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => setSkillsPanelOpen(true)}
                            className="text-slate-400 hover:text-slate-200 rounded-xl"
                        >
                            <BookOpen className="h-5 w-5" />
                        </Button>
                        <Link to={createPageUrl('Goals')}>
                            <Button
                                variant="ghost"
                                size="icon"
                                className="text-slate-400 hover:text-slate-200 rounded-xl"
                            >
                                <Target className="h-5 w-5" />
                            </Button>
                        </Link>
                    </div>
                </header>

                {/* Messages Area */}
                {!currentConversation && messages.length === 0 ? (
                    <WelcomeScreen aiName={aiName} onStartChat={handleStartChat} />
                ) : (
                    <>
                        <ScrollArea ref={scrollRef} className="flex-1">
                            <ProactiveSuggestions 
                                onSendMessage={handleSendMessage}
                                conversationId={currentConversation?.id}
                            />
                            
                            <div className="px-4 py-6">
                                <div className="max-w-3xl mx-auto space-y-6">
                                    {/* Reflection Prompts */}
                                    {reflections.length > 0 && (
                                        <ReflectionPrompt
                                            insight={reflections[0]}
                                            onRespond={handleReflectionRespond}
                                            onDismiss={handleReflectionDismiss}
                                        />
                                    )}

                                    {/* Project Hub */}
                                    {activeGoals.length > 0 && (
                                        <ProjectHub
                                            goalId={activeGoals[0].id}
                                            goalTitle={activeGoals[0].title}
                                        />
                                    )}

                                    {/* Practice Exercises */}
                                    {exercises.length > 0 && (
                                        <PracticeExercise
                                            exercise={exercises[0]}
                                            onSubmit={handleExerciseSubmit}
                                            onRequestHint={handleRequestHint}
                                        />
                                    )}
                                </div>
                            </div>

                            <EmotionalInsights conversationId={currentConversation?.id} />
                            
                            <div className="px-4">
                                <div className="max-w-3xl mx-auto space-y-6">
                                    <AnimatePresence>
                                        {messages.map((msg, index) => {
                                            // Check if message has images
                                            const hasImages = msg.file_urls && msg.file_urls.length > 0;
                                            
                                            if (hasImages) {
                                                return (
                                                    <div key={index} className="space-y-3">
                                                        {msg.file_urls.map((url, imgIndex) => (
                                                            <MediaMessage 
                                                                key={`${index}-${imgIndex}`}
                                                                imageUrl={url}
                                                                caption={imgIndex === 0 ? msg.content : null}
                                                                isUser={msg.role === 'user'}
                                                            />
                                                        ))}
                                                    </div>
                                                );
                                            }
                                            
                                            return (
                                                <MessageBubble 
                                                    key={index} 
                                                    message={msg} 
                                                    aiName={aiName}
                                                />
                                            );
                                        })}
                                    </AnimatePresence>
                                    
                                    {isTyping && <TypingIndicator aiName={aiName} />}
                                </div>
                            </div>
                        </ScrollArea>

                        {/* Input Area */}
                        <div className="p-4 bg-slate-900/50 backdrop-blur-xl border-t border-slate-800/50">
                            <div className="max-w-3xl mx-auto">
                                <ChatInput 
                                    onSend={handleSendMessage} 
                                    disabled={isTyping}
                                    onImageGenerate={() => setImageGenDialogOpen(true)}
                                />
                            </div>
                        </div>
                    </>
                )}
            </div>
        </div>
    );
}
